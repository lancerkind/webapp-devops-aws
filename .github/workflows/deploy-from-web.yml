name: Deploy upon Webapp update

on:
  repository_dispatch:
    types: [webapp-updated]
  workflow_dispatch:
    inputs:
      webapp_repo:
        description: 'Webapp repository (format: owner/repo)'
        required: true
      webapp_ref:
        description: 'Branch/tag/commit to deploy'
        required: false
        default: 'main'

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  APP_NAME: asgardeo-webapp-demo
  ENV_NAME: asgardeo-webapp-demo-env
  NODE_VERSION: '22'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout infrastructure repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine webapp source
        id: webapp_source
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "repo=${{ github.event.client_payload.webapp_repo }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.event.client_payload.webapp_ref }}" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.client_payload.webapp_sha }}" >> $GITHUB_OUTPUT
          else
            echo "repo=${{ inputs.webapp_repo }}" >> $GITHUB_OUTPUT
           # echo "ref=${{ inputs.webapp_ref || 'main' }}" >> $GITHUB_OUTPUT  # this line is superfluous.
            echo "sha=manual" >> $GITHUB_OUTPUT
          fi

      - name: Checkout webapp repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.webapp_source.outputs.repo }}
          ref: ${{ steps.webapp_source.outputs.ref }}
          path: webapp-source
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve checked-out SHA
        id: resolved_sha
        working-directory: webapp-source
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Detect webapp path
        id: detect_webapp_path
        shell: bash
        run: |
          if [ -f "webapp-source/webapp/package.json" ]; then
            echo "webapp_path=webapp-source/webapp" >> $GITHUB_OUTPUT
          else
            echo "Could not find package.json in expected locations (webapp-source/ or webapp-source/webapp)." 1>&2
            ls -la webapp-source || true
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ steps.detect_webapp_path.outputs.webapp_path }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ steps.detect_webapp_path.outputs.webapp_path }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build Vite webapp
        working-directory: ${{ steps.detect_webapp_path.outputs.webapp_path }}
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: |
          if npm run | grep -q " build"; then
            npm run build
          else
            echo "No build script found in package.json" 1>&2
            cat package.json
            exit 1
          fi

      - name: Package built webapp (dist -> webapp.zip)
        run: |
          WEBAPP_ROOT="${{ steps.detect_webapp_path.outputs.webapp_path }}"
          DIST_DIR="$WEBAPP_ROOT/dist"
          
          if [ ! -d "$DIST_DIR" ]; then
            echo "Build output directory 'dist' not found at $DIST_DIR" 1>&2
            exit 1
          fi

          # For beanstalk to work with Vite, a server.js and package.json are copied to the dist directory.
          if [ -f "$WEBAPP_ROOT/server/server.js"] && [-f "$WEBAPP_ROOT/server/package.json" ]; then
            cp "$WEBAPP_ROOT/server.js" "$DIST_DIR/"
            cp "$WEBAPP_ROOT/package.json" "$DIST_DIR/"
          else
            echo "Error: $WEBAPP_ROOT/server/server.js and it's package.json not found." 1>&2
            exit 1
          fi

          rm -f webapp.zip
          
          # 3. Package the contents of dist (now including server.js and package.json)
          (cd "$DIST_DIR" && zip -r ../../../webapp.zip .)
          ls -lh webapp.zip
          echo "Packaged webapp (Vite build + server.js) from SHA: ${{ steps.resolved_sha.outputs.sha }}"

      - name: Package service (optional)
        run: |
          if [ -d "webapp-source/service" ]; then
            cd webapp-source/service
            rm -f ../../service.zip
            # Package without parent directory
            zip -r ../../service.zip * -x "*.git*" -x "node_modules/*" -x ".github/*" -x "*.md"
            cd ../..
            ls -lh service.zip
            echo "Packaged service from SHA: ${{ steps.resolved_sha.outputs.sha }}"
          else
            echo "No service directory found in the external webapp repository. Skipping service packaging."
          fi

      - name: Terraform Init (S3 backend)
        working-directory: ./terraform
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=global/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform Plan
        working-directory: ./terraform
        run: terraform plan -input=false -out=tfplan -var="commit_sha=${{ steps.resolved_sha.outputs.sha }}"

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -input=false -auto-approve tfplan

      - name: Read Terraform outputs
        id: tf_outputs
        working-directory: ./terraform
        shell: bash
        run: |
          echo "bucket=$(terraform output -raw artifacts_bucket_name)" >> $GITHUB_OUTPUT
          echo "url=$(terraform output -raw beanstalk_environment_url)" >> $GITHUB_OUTPUT

      - name: Output environment URL
        run: |
          echo "Environment URL: ${{ steps.tf_outputs.outputs.url }}"

      - name: Health check
        run: |
          URL="${{ steps.tf_outputs.outputs.url }}"
          echo "Running health check on: $URL"
          for i in {1..30}; do
            echo "Attempt $i/30..."
            if curl -fsS "$URL" > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              curl -i "$URL"
              exit 0
            fi
            sleep 10
          done
          echo "âŒ Health check failed after 5 minutes"
          curl -i "$URL" || true
          exit 1

      - name: Output deployment info
        if: always()
        run: |
          echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment URL**: ${{ steps.tf_outputs.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Webapp SHA (resolved)**: ${{ steps.resolved_sha.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Webapp Repo**: ${{ steps.webapp_source.outputs.repo }}" >> $GITHUB_STEP_SUMMARY
