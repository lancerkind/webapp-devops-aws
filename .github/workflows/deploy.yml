name: Deploy to AWS Elastic Beanstalk

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  TF_CLOUD: false
  AWS_REGION: ${{ secrets.AWS_REGION }}
  APP_NAME: asgardeo-webapp-demo
  ENV_NAME: asgardeo-webapp-demo-env

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Build artifacts where Terraform expects them (repo root)
      - name: Package webapp for Terraform
        run: |
          rm -f webapp.zip
          (cd webapp && zip -r ../webapp.zip . -x "*.git*" -x "node_modules/*" -x ".github/*" -x "*.md")
          ls -lh webapp.zip

      - name: Package service for Terraform (if present)
        run: |
          if [ -d "service" ]; then
            rm -f service.zip
            (cd service && zip -r ../service.zip . -x "*.git*" -x "node_modules/*" -x ".github/*" -x "*.md")
            ls -lh service.zip
          else
            echo "Service directory not found in this repository. If deploying the service, use the 'Deploy from Webapp Update' workflow to package from the external webapp repo." >&2
          fi

      - name: Terraform Init (S3 backend)
        working-directory: ./terraform
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=global/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform Fmt (non-blocking)
        working-directory: ./terraform
        run: terraform fmt -recursive || true

      - name: Terraform Plan
        working-directory: ./terraform
        run: terraform plan -input=false -out=tfplan -var "commit_sha=${GITHUB_SHA}"

      - name: Terraform Apply (auto-approve)
        working-directory: ./terraform
        run: terraform apply -input=false -auto-approve tfplan

      - name: Read Terraform outputs
        id: tf_outputs
        working-directory: ./terraform
        shell: bash
        run: |
          echo "bucket=$(terraform output -raw artifacts_bucket_name)" >> $GITHUB_OUTPUT
          echo "url=$(terraform output -raw beanstalk_environment_url)" >> $GITHUB_OUTPUT

      # Terraform handles versioning and environment update

      - name: Output environment URL
        run: |
          echo "Environment URL: ${{ steps.tf_outputs.outputs.url }}"

      - name: Health check
        run: |
          URL="${{ steps.tf_outputs.outputs.url }}"
          echo "Checking $URL ..."
          for i in {1..20}; do
            if curl -fsS "$URL" > /dev/null; then
              echo "Health check passed"; exit 0; fi
            sleep 10; done
          echo "Health check failed"; curl -i "$URL" || true; exit 1
